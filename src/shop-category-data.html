<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="shop-category-data">

<template>
 <template is="dom-if" if="{{fb}}">
<!--      <firebase-app api-key="AIzaSyAMDWKG7qyQ9msJaaKb7vmvK-rNu3X_7-Q" auth-domain="project-604055857022237684.firebaseapp.com" database-url="https://project-604055857022237684.firebaseio.com" storage-bucket="project-604055857022237684.appspot.com"></firebase-app> -->
<!--     <firebase-auth id="auth" signed-in="{{signedIn}}" user="{{_user}}"></firebase-auth> -->
<!--     <firebase-document id="doc" path="/shop" data="{{app}}"></firebase-document>       -->

</template>
<!-- <firebase-query
        id="categories-query"
        path="/shop/categories"
        data="{{_categories}}">
</firebase-query> -->
<!-- <app-localstorage-document key="shop-data-categories" data="{{categories}}"></app-localstorage-document> -->
<!-- <firebase-document
  path="/shop/categories/{{categoryName}}"
  data="{{category}}">
</firebase-document> -->
<!-- <firebase-query
        id="category-query"
        path="/shop/categories/{{categoryName}}/items"
        data="{{items}}">
</firebase-query> -->

<!-- <firebase-document
  path="/shop/items/{{itemName}}"
  data="{{item}}">
</firebase-document> -->

</firebase-query>

</template>

  <script>



(function() {
    
    
    Polymer({
        
        is: 'shop-category-data',
        
        properties: {
            
            categoryName: String,
            key: String,
            
            itemName: String,
            
            categories: {
                type: Array,
                notify: true,
            },
            
            category: {
                type: Object,
                //computed: '_computeCategory(categoryName,categories.*)',
                notify: true,
            },
            
            items: {
                type: Array,
                //computed: '_computeItem(category.items, itemName)',
                notify: true
            },
             item: {
                type: Array,
                notify: true
            },
            
            failure: {
                type: Boolean,
                notify: true,
                readOnly: true
            }
        },
        
        observers: [
        '_changed(_categories.*)',
        '_changed2(categoryName)'

        ],
        
        _changed: function(categories) {
            //console.log(categories);
            this.set('categories', categories.base);
        },

        _changed2: function(category) {
            console.log(category);
        },
        
        _getCategoryObject: function(categoryName) {
            
            for (var i = 0, c; c = this.categories[i]; ++i) {
                console.log(this.categories[i]);
                if (c.name === categoryName) {
                    return c;
                }
            }
            return null ;
        },
        
        _computeCategory: function(categoryName, categories) {
            // Fetch the items of the category. Note that the fetch is asynchronous,
            // which means `category.items` may not be set initially (but that path
            // will be notified when the fetch completes).
            //var categoryObj = this._getCategoryObject(categoryName);
            //this._fetchItems(categoryObj, 1);
            //return categoryObj;
            //console.log(categoryName, categories.base.length);
            for (var i = 0, c; c = this.categories[i]; ++i) {
                console.log(this.categories[i]);
//                 if (c.name === categoryName) {
//                     return c;
//                 }
            }
            return null ;
        },
        
        _computeItem: function(items, itemName) {
            for (var i = 0, item; item = items[i]; ++i) {
                if (item.name === itemName) {
                    return item;
                }
            }
        },
        
        _fetchItems: function(category, attempts) {
            this._setFailure(false);
            // Only fetch the items of a category if it has not been previously set.
            if (!category || category.items) {
                return;
            }
            this._getResource({
                url: '/data/' + category.name + '.json',
                onLoad: function(e) {
                    this.set('category.items', JSON.parse(e.target.responseText));
                },
                onError: function(e) {
                    this._setFailure(true);
                }
            }, attempts);
        },
        
        _getResource: function(rq, attempts) {
            var xhr = new XMLHttpRequest();
            xhr.addEventListener('load', rq.onLoad.bind(this));
            xhr.addEventListener('error', function(e) {
                // Flaky connections might fail fetching resources
                if (attempts > 1) {
                    this.debounce('_getResource', this._getResource.bind(this, rq, attempts - 1), 200);
                } else {
                    rq.onError.call(this, e);
                }
            }
            .bind(this));
            
            xhr.open('GET', rq.url);
            xhr.send();
        },
        
        refresh: function() {
            if (this.categoryName) {
                // Try at most 3 times to get the items.
                this._fetchItems(this._getCategoryObject(this.categoryName), 3);
            }
        }
    
    });

})();
</script>

</dom-module>