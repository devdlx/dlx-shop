<!DOCTYPE html>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">

<script src="https://cdn.jsdelivr.net/webtorrent/latest/webtorrent.min.js">
</script>

<dom-module id="dlx-video">
	<style is="custom-style">


:host {
    --dlx-video-controls-background: white;
    --dlx-video-controls-color: #595959;
    --dlx-video-slider-color: #3367D6;
    min-height: 239px;
    background: black;
}

:host paper-ripple {
    color: --dlx-video-controls-color;
}

:host paper-slider {
    --paper-slider-active-color: var(--dlx-video-slider-color);
    --paper-slider-knob-color: var(--dlx-video-slider-color);
}

:host .container {
    position: relative;
    display: inline-block;
    height: 100%;
    width: 100%;

}

:host #videoControls {
    /*     position: absolute; */
    /*bottom: 4px;*/
    /*     bottom: -64px;
                                                                                                                                        left: 0;
                                                                                                                                        right: 0; */
    margin-top: -5px;
    display: flex;
    color: var(--dlx-video-controls-color);
    background-color: var(--dlx-video-controls-background);
    padding: 15px;
    align-items: center;
}

#videoControls > * {
    margin-right: 8px;
}

:host paper-ripple {
    color: white;
    opacity: 0.4;
}

:host #durationSlider {
    flex: 1;
}

:host #volumeSlider {
    max-width: 120px;
}

:host .video-time {
    font-family: 'Roboto';
    font-size: 12px;
}

:host #container:-webkit-full-screen,
:host #container:-webkit-full-screen video {
    width: 100vw;
    height: 100vh;
}

:host video {
    background-color: black;
    height: 100%;
    width: 100%;
}
@media (max-width: 767px) {
    2:host #toggleMuteButton {
        display:none;
    }
    2:host #volumeSlider {
        display: none;
    }
}
</style>
	<template>
		<div id="container" class="container layout vertical">
			
			<div class="video" id="video" hidden$="[[!raw]]">
				<paper-ripple></paper-ripple>
				<video on-tap="toggle" width$="{{width}}" muted$="{{muted}}" poster$="{{poster}}" preload$="{{preload}}" height$="{{height}}" id="paperVideo" src$="{{src}}" autoplay$="{{autoplay}}" loop$="{{loop}}"></video>
			</div>

			<template is="dom-if" if="{{youtubeId}}">
            	<google-youtube currenttime="{{currentTime}}" currenttimeformatted="{{currentTick}}" durationformatted="{{durationTick}}" id="yt" fluid video-id="{{youtubeId}}" rel="0" start="1" autoplay="1" chromeless on-google-youtube-state-change="_youtubeState"></google-youtube>
       		</template>

<!-- 			<template is="dom-if" if="[[controls]]" restamp="true"> -->
				<paper-material elevation="1" hidden$="{{!controls}}" id="videoControls">

					<paper-icon-button id="playPauseButton" on-click="togglePlayPause" icon="{{playPauseIcon}}"></paper-icon-button>

					<span class="video-time">{{currentTick}}/{{durationTick}}</span>

					<paper-slider id="durationSlider" value="[[videoTimeline]]" on-change="setTimelineFrame"  ></paper-slider>

					<paper-icon-button id="toggleMuteButton" icon="[[volumeIcon]]" on-click="toggleMute" hidden$="[[narrow]]"></paper-icon-button>

					<paper-slider id="volumeSlider" value="{{videoVolume}}" on-change="_changeVolume" hidden$="[[narrow]]"  ></paper-slider>

					<paper-icon-button id="toggleFullScreenButton" icon="icons:fullscreen" on-click="toggleFullScreen"></paper-icon-button>
					
				</paper-material>
<!-- 			</template> -->
			</div>
		</div>
	</template>
	<script>


Polymer({
    is: 'dlx-video',
    properties: {
        item: {
            type: Object,
            notify: true,
            value: {}
        },
        controls: {
            type: Boolean,
            value: true
        },
        autoplay: {
            type: Boolean,
            value: false
        },
        loop: {
            type: Boolean,
            value: false
        },
        preload: {
            type: Boolean,
            value: false
        },
        muted: {
            type: Boolean,
            value: false
        },
        playPauseIcon: {
            value: 'av:play-arrow'
        },
        videoVolume: {
            value: 100
        },
        volumeIcon: {
            type: String,
            value: 'av:volume-up'
        },
        videoTimeline: {
            type: Number
        },
        link: {
            type: String,
            value: 'magnet:?xt=urn:btih:5fb2eb4a22389fcf87346dff1d88c8fe813b26ad&dn=South.Park.S18E09.REHASH.UNCENSORED.720p.WEB-DL.x264.AAC.mp4&tr=udp%3A%2F%2Fexodus.desync.com%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.internetwarriors.net%3A1337&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.openbittorrent.com%3A80&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&tr=wss%3A%2F%2Ftracker.webtorrent.io'
            //value: 'magnet:?xt=urn:btih:202effd79e2ec2b40b872c1b401d9dd47cbef5f0&dn=007+James+Bond+Quantum+of+Solace+2008+720p+BluRay+x264+AAC+-+Ozlem.mp4&tr=udp%3A%2F%2Fexodus.desync.com%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.internetwarriors.net%3A1337&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.openbittorrent.com%3A80&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&tr=wss%3A%2F%2Ftracker.webtorrent.io'
            //value: 'https://www.youtube.com/watch?v=pwKKDgiLVkw'
            //value: 'https://youtu.be/1IkTFHCUYLA?t=120'
        }
    
    },
    
    listeners: {
        'canplay': '_canplay',
        'timeupdate': '_timeupdate'
    },
    
    observers: [
    '_link(link)', 
    '_youtubeTimeupdate(currentTime)'
    
    ],
    
    _canplay: function(event) {
        //console.log(event);
        video = this.$.paperVideo;
        this.set('currentTick', this.readableDuration(video.currentTime));
        this.set('durationTick', this.readableDuration(video.duration));
    },
    
    _youtubeTimeupdate: function(currentTime) {
        //this.set('currentTime', this.$.yt.currentTime);
        this.set('duration', this.$.yt.duration);
        this.set('videoTimeline', (currentTime / this.duration) * 100);
        //console.log(this.videoTimeline);
    },
    
    _timeupdate: function(event) {
        //console.log(event.timeStamp );
        if (this.$.paperVideo.paused || this.$.paperVideo.ended)
            this.set('playPauseIcon', 'av:play-arrow');
        else
            this.set('playPauseIcon', 'av:pause');
        
        video = this.$.paperVideo;
        this.set('currentTick', this.readableDuration(video.currentTime));
        
        // Setting the video parameters to the component
        this.set('duration', video.duration);
        this.set('currentTime', video.currentTime);
        //console.log((video.currentTime / video.duration)*100);
        this.set('videoTimeline', (video.currentTime / video.duration) * 100);
    
    },
    setTimelineFrame: function(event) {
        console.log('setTimelineFrame');
        if (this.youtubeId) {
            console.log(event.target.value);
            this.$.yt.seekTo(event.target.value);
        } else {
            video = this.$.paperVideo;
            console.log(video);
            video.currentTime = Math.floor(video.duration * event.target.getAttribute('value') / 100);
        }
    },
    _changeVolume: function(event) {
        if (this.youtubeId && typeof event === 'number') {
            this.set('videoVolume', event);
        } else {
        
        
        }
        
        //         if (this.videoVolume / 100) {
        //             this.set('volumeIcon', 'av:volume-up');
        //         } else {
        //             this.set('volumeIcon', 'av:volume-off');
        //         }
    },
    readableDuration: function(seconds) {
        sec = Math.floor(seconds);
        min = Math.floor(sec / 60);
        min = min >= 10 ? min : '0' + min;
        sec = Math.floor(sec % 60);
        sec = sec >= 10 ? sec : '0' + sec;
        
        return min + ':' + sec;
    },
    play: function() {
        return this.$.paperVideo.play();
    },
    pause: function() {
        return this.$.paperVideo.pause();
    },
    togglePlayPause: function() {
        //         console.log(this.$.yt.state);
        if (this.youtubeId) {
            //             console.log(this.$.yt.state);
            switch (this.$.yt.state) {
            case -1:
                this.$.yt.play();
                break;
            case 0:
                //                 console.log('ended');
                this.$.yt.play();
                //switch icon to replay
                break;
            case 1:
                //                 console.log('playing');
                this.$.yt.pause();
                break;
            case 2:
                //                 console.log('paused');
                this.$.yt.play();
                break;
            case 3:
                //                 console.log('buffering');
                this.set('playPauseIcon', '');
                //disable while buffering
                break;
            case 5:
                //                 console.log('video cued');
                //video is ready
                break;
            default:
                console.log('no youtube state');
            }
        } else {
            video = this.$.paperVideo;
            if (video.paused || video.ended) {
                this.play();
            } else {
                this.pause();
            }
        }
    
    },
    toggleMute: function(event) {
        if (this.youtubeId) {
            //console.log('toggleMute');
            //this.set('volumeIcon', 'av:volume-up');
            if (!this.muted) {
                this.$.yt.mute();
                this.set('volumeIcon', 'av:volume-off');
            } else if (this.muted) {
                this.$.yt.unMute();
                this.set('volumeIcon', 'av:volume-up');
            }
        }
        this.set('muted', !this.muted);
    
    },
    
    toggleFullScreen: function(elem) {
        elem = this.$.container;
        //elem = elem || document.documentElement;
        if (!document.fullscreenElement && !document.mozFullScreenElement && 
        !document.webkitFullscreenElement && !document.msFullscreenElement) {
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }
    },
    
    
    _link: function(link) {
        //console.log(link);
        
        //console.log(link.match(/((http|https)\:\/\/)?[a-zA-Z0-9\.\/\?\:@\-_=#]+\.([a-zA-Z0-9\&\.\/\?\:@\-_=#])*/));
        
        if (link.match(/magnet:\?xt/i)) {
            this._magentUrl(link);
            //} else if (link.match(/^(https?\:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/)) {
        } else if (link.match(/^((?:https?:)?\/\/)?((?:www|m)\.)?((?:youtube\.com|youtu.be))(\/(?:[\w\-]+\?v=|embed\/|v\/)?)([\w\-]+)(\S+)?$/)) {
            this._youtubeUrl(link);
        } else {
            _rawLink(link);
        }
    
    },
    
    
    _rawLink: function(link) {
        let parts = link.split("/");
        let rawName = parts[parts.length - 1].split('?')[0];
        let title = rawName.replace(/[^a-zA-Z0-9]/g, ' ');
        let media = {};
        media.title = title;
        _fetchInfo(media);
    },
    
    _youtubeState: function(event) {
        //console.log(event.detail.data);
        let state = event.detail.data;
        
        switch (state) {
        case -1:
            //             console.log('unstarted');
            this.set('playPauseIcon', 'av:play-arrow');
            break;
        case 0:
            //             console.log('ended');
            this.set('playPauseIcon', 'av:play-arrow');
            //switch icon to replay
            break;
        case 1:
            //             console.log('playing');
            this.set('playPauseIcon', 'av:pause');
            break;
        case 2:
            //             console.log('paused');
            this.set('playPauseIcon', 'av:play-arrow');
            break;
        case 3:
            //             console.log('buffering');
            this.set('playPauseIcon', '');
            //disable while buffering
            break;
        case 5:
            //             console.log('video cued');
            //video is ready
            break;
        default:
            console.log('no youtube state');
        }
    
    },
    ytId: function ytVidId(url) {
        let p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
        console.log(p)
        return (url.match(p)) ? RegExp.$1 : false;
    },
    
    
    _youtubeUrl: function(link) {
        
        let _youtubeId = this.ytId(link);
        let url = 'https://www.googleapis.com/youtube/v3/videos?part=contentDetails,liveStreamingDetails,snippet&key=AIzaSyAMDWKG7qyQ9msJaaKb7vmvK-rNu3X_7-Q&id=' + _youtubeId;
        
        
        var request = new XMLHttpRequest();
        request.open('GET', url);
        
        request.setRequestHeader('Accept', 'application/json');
        that = this;
        request.onreadystatechange = function() {
            if (request.readyState === 4) {
                //console.log('Status:', this.status);
                //console.log('Headers:', this.getAllResponseHeaders());
                //console.log('Body:', JSON.parse(this.responseText));
                let item = JSON.parse(request.responseText);
                if (item.error) {
                    //console.log(item);
                    //this.set('error', item.error);
                    this.set('failure', true);
                    //this.set('youtubeId', _youtubeId);
                    return;
                }
                //console.log(item.items[0]);
                
                if (item.pageInfo.totalResults === 1) {
                    this.set('failure', false);
                    this.set('youtubeId', _youtubeId);
                    this.set('raw', false);
                    let media = item.items[0].snippet;
                    media.liveStreamingDetails = item.items[0].liveStreamingDetails || {};
                    media.contentDetails = item.items[0].contentDetails || {};
                    
                    this.set('item', media);
                
                }
            
            }
        }
        .bind(this);
        
        request.send();
    
    
    },
    
    
    _magentUrl: function(magnetURI) {
        //console.log(this.link);
        var client = new WebTorrent();
        client.add(magnetURI, function(torrent) {
            // Got torrent metadata!
            //console.log('Client is downloading:', torrent.infoHash);
            var file = torrent.files[0];
            //console.log(file);
            
            this._fetchInfo({
                title: file.name
            });
            
            
            file.getBlobURL(function(err, url) {
                if (err)
                    throw err;
                //                 console.log(url);
                this._fetchInfo({
                    'title': file.name,
                    'mediaUrl': url
                });
                
                
                let bytesText = function formatBytesText(bytes) {
                    if (bytes < 1024)
                        return bytes + " Bytes";
                    else if (bytes < 1048576)
                        return (bytes / 1024).toFixed(2) + " KB";
                    else if (bytes < 1073741824)
                        return (bytes / 1048576).toFixed(2) + " MB";
                    else
                        return (bytes / 1073741824).toFixed(2) + " GB";
                }
                console.log(bytesText(file.length));
            }
            .bind(this));
        }
        .bind(this));
    },
    
    
    
    
    
    _fetchInfo: function(media) {
        let apikey = "33dce8e62b60a6fc148ed731ff825268";
        let type = media.type || 'movie';
        
        media.title = 'South.Park.season18.episode09.REHASH.UNCENSORED.720p.WEB-DL.x264.mp4';
        //console.log(media.title);
        // find Season format
        //      /([s-s]\d?\d|[S-S]\d?\d)/g
        let regexS1 = /(?:[s-s](\d?\d))/i;
        let regexS2 = /(?:\bseason(\d?\d))/i;
        let regexE1 = /(?:[e-e](\d?\d))/i;
        let regexE2 = /(?:\bepisode(\d?\d))/i;
        
        if (media.title.match(regexS1)) {
            media.season = media.title.match(regexS1)[1];
        }
        
        if (media.title.match(regexS2)) {
            media.season = media.title.match(regexS2)[1];
        }
        
        if (media.title.match(regexE1)) {
            media.episode = media.title.match(regexE1)[1];
        }
        
        if (media.title.match(regexE2)) {
            media.episode = media.title.match(regexE2)[1];
        }
        
        console.log(media);
        
        
        
        
        // find year format
        // /\d{4}/
        if (media.title.match(/\d{4}/)) {
            //console.log('year:', media.title.match(/\d{4}/)[0]);
            media.year = media.title.match(/\d{4}/)[0];
            media.title = media.title.split(media.year)[0];
        }
        
        
        let url = 'https://api.themoviedb.org/3/search/' + type + '?api_key=' + apikey + '&query=' + media.title;
        
        
        
        
        
        
        url = encodeURI(url);
        
        //console.log(media);
        
        var request = new XMLHttpRequest();
        request.open('GET', url);
        
        request.setRequestHeader('Accept', 'application/json');
        that = this;
        request.onreadystatechange = function() {
            if (this.readyState === 4) {
                //console.log('Status:', this.status);
                //console.log('Headers:', this.getAllResponseHeaders());
                console.log('Body:', JSON.parse(this.responseText));
                item = JSON.parse(this.responseText).results[0];
                if (!item) {
                    //media.backdrop_path = 'http://www.much.com/wp-content/uploads/2015/05/featured-south-park1.jpg';
                    //console.log(item);
                    that.set('item', media);
                    return;
                }
                item.description = item.overview;
                item.poster_path = 'http://image.tmdb.org/t/p/w500' + item.poster_path;
                item.backdrop_path = 'http://image.tmdb.org/t/p/w500' + item.backdrop_path;
                console.log(item);
                //'http://api.themoviedb.org/3/movie/{imdbid}/images?api_key='
                that.set('item', item);
            }
        }
        
        request.send();
    
    },






})
</script>
</dom-module>
