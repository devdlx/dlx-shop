
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<dom-module id="shop-cart-data">

  <template>
        <app-localstorage-document key="shop-cart-data" data="{{cart}}"></app-localstorage-document>
  </template>

  <script>

(function() {
    'use strict';
    
    
    let MyBehavior = {
    };
    
    class dlxData {
        
        // Define behaviors with a getter.
        get behaviors() {
            return [MyBehavior];
        }
        
        // Element setup goes in beforeRegister instead of createdCallback.
        beforeRegister() {
            this.is = 'shop-cart-data';
            
            // Define the properties object in beforeRegister.
            this.properties = {
                
                cart: {
                    type: Array,
                    notify: true,
                    value: []
                },
                numItems: {
                    type: Number,
                    computed: '_computeNumItems(cart.splices)',
                    notify: true
                },
                total: {
                    type: Number,
                    computed: '_computeTotal(cart.splices)',
                    notify: true
                }
            };
        }
        
        // #ready
        ready() {
        }
        
        addItem(detail) {
            var i = this._indexOfEntry(detail.item.name, detail.size);
            if (i !== -1) {
                detail.quantity += this.cart[i].quantity;
            }
            this.setItem(detail);
        }
        
        setItem(detail) {
            var i = this._indexOfEntry(detail.item.name, detail.size);
            if (detail.quantity === 0) {
                // Remove item from cart when the new quantity is 0.
                if (i !== -1) {
                    this.splice('cart', i, 1);
                }
            } else {
                // Use Polymer's array mutation methods (`splice`, `push`) so that observers
                // on `cart.splices` are triggered.
                if (i !== -1) {
                    this.splice('cart', i, 1, detail);
                } else {
                    this.push('cart', detail);
                }
            }
        }
        clearCart() {
            this.cart = [];
        }
        _computeNumItems() {
            if (this.cart) {
                return this.cart.reduce(function(total, entry) {
                    return total + entry.quantity;
                }, 0);
            }
            return 0;
        }
        _computeTotal() {
            if (this.cart) {
                return this.cart.reduce(function(total, entry) {
                    return total + entry.quantity * entry.item.price;
                }, 0);
            }
            return 0;
        }
        _indexOfEntry(name, size) {
            if (this.cart) {
                for (var i = 0; i < this.cart.length; ++i) {
                    var entry = this.cart[i];
                    if (entry.item.name === name && entry.size === size) {
                        return i;
                    }
                }
            }
            return -1;
        }
        
        
        _initializeCart() {
            this.clearCart();
        }
        
        attached() {

        }
        detached() {}
        attributeChanged() {}
    }
    
    // Register the element using Polymer's constructor.
    Polymer(dlxData);
})();
</script>

</dom-module>
